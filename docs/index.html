<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>brokerbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();const P=["Executed","Cancelled","Expired","Pending","Rejected"],H=["Security","Cash"],B=["Buy","Sell","Distribution","Interest","Taxes","Fee","Deposit","Withdrawal","Corporate action"];function D(r,e){if(r.time.getFullYear()<2e3||r.time.getFullYear()>2100)return`Invalid year ${r.time.getFullYear()} in row ${JSON.stringify(e)}`;if(!P.includes(r.status))return`Invalid status ${r.status} in row ${JSON.stringify(e)}`;if(!H.includes(r.assetType))return`Invalid asset type ${r.assetType} in row ${JSON.stringify(e)}`;if(!B.includes(r.type))return`Invalid transaction type ${r.type} in row ${JSON.stringify(e)}`;if(isNaN(r.shares))return`Invalid shares ${e.shares} in row ${JSON.stringify(e)}`;if(isNaN(r.price)||r.price<0)return`Invalid price ${e.price} in row ${JSON.stringify(e)}`;if(isNaN(r.amount))return`Invalid amount ${e.amount} in row ${JSON.stringify(e)}`;if(isNaN(r.fee)||r.fee<0)return`Invalid fee ${e.fee} in row ${JSON.stringify(e)}`;if(isNaN(r.tax)||r.tax<0)return`Invalid tax ${e.tax} in row ${JSON.stringify(e)}`;if(r.currency!=="EUR")return`Expecting only EUR but got ${e.currency} in row ${JSON.stringify(e)}`;const n=r.price*r.shares*(r.type==="Buy"?-1:1);return r.shares!==0&&Math.abs(n-r.amount)>.01?`Invalid amount ${e.amount} - expected ${n} in row ${JSON.stringify(e)}`:""}function K(r){const e=r.split(`
`),n=e[0].split(";");e.shift();const s=[];for(let t of e){if(t=t.trim(),!t)continue;const o=t.split(";");if(o.length!==n.length)throw new Error(`Invalid row: ${t}`);const i=new Map;i.set("raw",t);for(let d=0;d<n.length;d++){let p=o[d];p.startsWith('"')&&p.endsWith('"')&&(p=p.slice(1,-1)),i.set(n[d],p)}s.push(Object.fromEntries(i))}return s}function U(r){const e=K(r),n=[],s=[];for(const t of e){const o={raw:t.raw,time:W(t.date,t.time),status:t.status,reference:t.reference,description:t.description,assetType:t.assetType,type:t.type,isin:t.isin,shares:b(t.shares),price:b(t.price),amount:b(t.amount),fee:b(t.fee),tax:b(t.tax),currency:t.currency,sharesSold:0,gainOrLoss:0},i=D(o,t);if(i){s.push(i);continue}n.push(o)}return n.sort((t,o)=>t.time.getTime()-o.time.getTime()),{transactions:n,errors:s}}function b(r){return r?parseFloat(r.replace(/\./,"").replace(/\,/,".")):0}function W(r,e){const n=new Date(r),s=e.split(":");return n.setHours(Number(s[0]),Number(s[1]),Number(s[2])),n}class j{render(e){const n=document.createElement("div");n.classList.add("sectionErrors");for(const s of e.file.errors){const t=document.createElement("div");t.innerText=s,t.classList.add("error"),n.appendChild(t)}return n}}function q(r){const e=r.transactions.filter(s=>s.status==="Executed").sort((s,t)=>s.time.getTime()-t.time.getTime());z(e);const n=new Map;for(const s of e)s.isin&&s.description&&n.set(s.isin,s.description);return{cryptoIsins:[],isinToTitle:n,file:r,executedTransactions:e}}function z(r){const e=r.filter(n=>n.type==="Sell");for(const n of e){const s=r.filter(i=>i.type==="Buy"&&i.isin===n.isin&&i.shares>i.sharesSold);let t=n.shares,o=0;for(const i of s){const d=Math.min(i.shares-i.sharesSold,t);if(i.sharesSold+=d,o+=d*i.price,t-=d,t===0)break}if(t>0)throw new Error(`Not enough shares to sell for ${n.reference}`);n.gainOrLoss=n.amount-o-n.fee-n.tax}}function k(r){let e=0;for(const n of r)n.type==="Buy"?e+=n.shares:n.type==="Sell"&&(e-=n.shares);return e}function Y(r){return["Shares","Price","Amount","Fee","Tax","Gain/Loss"].includes(r)}class Q{render(e){const n=document.createElement("div"),s=document.createElement("h2");s.innerText="Realized gain / loss per year",n.appendChild(s);const t=e.executedTransactions.map(i=>i.time.getUTCFullYear()),o=Array.from(new Set(t)).sort((i,d)=>i-d);for(const i of o){const d=e.executedTransactions.filter(p=>p.time.getUTCFullYear()===i&&p.gainOrLoss!==0);d.length!==0&&n.appendChild(this.renderYearSection(e,i,d))}return n}renderYearSection(e,n,s){const t=document.createElement("div"),o=document.createElement("h3");o.innerText="Calendar year "+n,t.appendChild(o);const i=document.createElement("table");i.classList.add("yearSecurityTable"),t.appendChild(i);const d=document.createElement("thead");i.appendChild(d);const p=document.createElement("tr");d.appendChild(p);const $=["Security","Gain/Loss"];for(const l of $){const u=document.createElement("th");u.innerText=l,Y(l)&&u.classList.add("numeric"),p.appendChild(u)}const L=new Map;for(const l of s){const u=l.isin,h=L.get(u)||0;L.set(u,h+l.gainOrLoss)}for(const[l,u]of L){const h=document.createElement("tr");i.appendChild(h);const w=document.createElement("td"),y=document.createElement("a");y.innerText=e.isinToTitle.get(l)||l,y.href="#"+l,w.appendChild(y),h.appendChild(w);const T=document.createElement("td");T.innerText=u.toFixed(2),T.classList.add(u>0?"positive":"negative"),h.appendChild(T)}const m=Array.from(i.rows).slice(1);m.sort((l,u)=>l.cells[0].innerText.localeCompare(u.cells[0].innerText));for(const l of m)i.appendChild(l);const g=document.createElement("tr");g.classList.add("totalRow"),i.appendChild(g);const O=document.createElement("td");O.innerText="Total",g.appendChild(O);const S=document.createElement("td"),v=s.reduce((l,u)=>l+u.gainOrLoss,0);return S.innerText=v.toFixed(2),S.classList.add(v>0?"positive":"negative"),g.appendChild(S),t}}class V{render(e){const n=document.createElement("div"),s=X(e.executedTransactions),t=[];for(const o of s)t.push(this.renderGroup(o[1]));return t.sort((o,i)=>o.dataset.sortKey.localeCompare(i.dataset.sortKey)),n.replaceChildren(...t),n}renderGroup(e){const n=document.createElement("div");if(n.classList.add("transactionGroup"),e.length===0)return n;e.sort((a,c)=>a.time.getTime()-c.time.getTime());const s=e[0];n.dataset.sortKey=`${s.isin.length>0?1:0}${s.description}`;const t=s.isin?s.description:s.type,o=document.createElement("h2");if(o.innerText=t,o.id=s.isin,n.appendChild(o),s.isin){o.innerText+=" / ";const a=document.createElement("a");a.innerText=s.isin,a.href="https://scalable.capital/broker/security?isin="+s.isin,o.appendChild(a)}const i=document.createElement("table"),d=document.createElement("div");d.classList.add("tableScroller"),d.appendChild(i),n.appendChild(d);const p=document.createElement("thead"),$=document.createElement("tr");p.appendChild($),i.appendChild(p);const L=["Time","Type","Shares","Price","Amount","Fee","Tax","Gain/Loss"];for(const a of L){const c=document.createElement("th");c.innerText=a,Y(a)&&c.classList.add("numeric"),$.appendChild(c)}for(const a of e){const c=document.createElement("tr");c.title=a.raw,i.appendChild(c);const E=[a.time.toISOString().split("T")[0],a.type,a.shares,a.price,a.amount,a.fee,a.tax,a.gainOrLoss];for(let x=0;x<E.length;x++){const C=E[x],f=document.createElement("td");C===0?f.innerText="":typeof C=="number"?(f.innerText=C.toFixed(2),f.classList.add("numeric"),["Amount","Gain/Loss"].includes(L[x])&&f.classList.add(C>0?"positive":"negative")):f.innerText=String(C),c.appendChild(f)}}const m=document.createElement("tr");m.classList.add("totalRow"),i.appendChild(m);const g=document.createElement("td");g.innerText="Total",m.appendChild(g),m.appendChild(document.createElement("td"));const O=document.createElement("td"),S=k(e);S&&(O.innerText=S.toFixed(2)),m.appendChild(O),m.appendChild(document.createElement("td"));const v=document.createElement("td"),l=e.reduce((a,c)=>a+c.amount,0);l&&(v.innerText=l.toFixed(2),v.classList.add(l>0?"positive":"negative")),m.appendChild(v);const u=document.createElement("td"),h=e.reduce((a,c)=>a+c.fee,0);h&&(u.innerText=h.toFixed(2),u.classList.add(h>0?"positive":"negative")),m.appendChild(u);const w=document.createElement("td"),y=e.reduce((a,c)=>a+c.tax,0);y&&(w.innerText=y.toFixed(2),w.classList.add(y>0?"positive":"negative")),m.appendChild(w);const T=document.createElement("td"),I=e.reduce((a,c)=>a+c.gainOrLoss,0);I&&(T.innerText=I.toFixed(2),T.classList.add(I>0?"positive":"negative")),m.appendChild(T);const F=new Map;for(const a of e){if(a.gainOrLoss===0)continue;const c=a.time.getUTCFullYear(),E=F.get(c)||0;F.set(c,E+a.gainOrLoss)}if(F.size>0){const a=document.createElement("br");n.appendChild(a);const c=document.createElement("table");n.appendChild(c);const E=document.createElement("thead"),x=document.createElement("tr");E.appendChild(x),c.appendChild(E);const C=["Year","Gain/Loss"];for(const f of C){const N=document.createElement("th");N.innerText=f,Y(f)&&N.classList.add("numeric"),x.appendChild(N)}for(const[f,N]of F){const R=document.createElement("tr");c.appendChild(R);const A=document.createElement("td");A.innerText=String(f),R.appendChild(A);const G=document.createElement("td");G.innerText=N.toFixed(2),G.classList.add(N>0?"positive":"negative"),R.appendChild(G)}}return n}}function X(r){const e=new Map;for(const n of r){const s=Z(n),t=e.get(s)||[];t.push(n),e.set(s,t)}return e}function Z(r){return r.isin?r.isin:r.type==="Deposit"||r.type==="Withdrawal"?"Deposit/Withdrawal":r.type}const J=document.getElementById("transactionInput");J.addEventListener("change",M);function M(){const r=J.files;if(!r)return;const e=r[0];if(!e)return;const n=new FileReader;n.onload=()=>{_(U(n.result))},n.onerror=s=>{alert(`Error reading file: ${s}`)},n.readAsText(e)}M();function _(r){const e=q(r);document.getElementById("transactionOutput").replaceChildren(new j().render(e),new Q().render(e),new V().render(e))}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:800px;margin:0 auto 50px}.error{color:red}table{border-collapse:collapse}.yearSecurityTable{width:100%}th,td{padding:5px;border:1px solid #ddd;text-align:left;min-width:50px}th,.totalRow{background-color:#f2f2f2;font-weight:700}.numeric{text-align:right}.positive{color:green;text-align:right}.negative{color:red;text-align:right}

</style>
</head>

<body>
  <h1>📖 brokerbuch</h1>
  <p>
    Open-source tool for analysing Scalable Capital broker transaction log.
    <a href="https://github.com/kachurovskiy/brokerbuch/">Learn more on GitHub</a>
  </p>
  <p>All amounts shown in Euro. Ignoring cancelled, rejected, pending or expired transactions.</p>
  <p>
    Transactions CSV: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <div id="transactionOutput"></div>
  
</body>

</html>
