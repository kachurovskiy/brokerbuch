<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>brokerbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();const P=["Executed","Cancelled","Expired","Pending","Rejected"],B=["Security","Cash"],H=["Buy","Sell","Distribution","Interest","Taxes","Fee","Deposit","Withdrawal","Corporate action"];function D(e,t){if(e.time.getFullYear()<2e3||e.time.getFullYear()>2100)return`Invalid year ${e.time.getFullYear()} in row ${JSON.stringify(t)}`;if(!P.includes(e.status))return`Invalid status ${e.status} in row ${JSON.stringify(t)}`;if(!B.includes(e.assetType))return`Invalid asset type ${e.assetType} in row ${JSON.stringify(t)}`;if(!H.includes(e.type))return`Invalid transaction type ${e.type} in row ${JSON.stringify(t)}`;if(isNaN(e.shares))return`Invalid shares ${t.shares} in row ${JSON.stringify(t)}`;if(isNaN(e.price)||e.price<0)return`Invalid price ${t.price} in row ${JSON.stringify(t)}`;if(isNaN(e.amount))return`Invalid amount ${t.amount} in row ${JSON.stringify(t)}`;if(isNaN(e.fee)||e.fee<0)return`Invalid fee ${t.fee} in row ${JSON.stringify(t)}`;if(isNaN(e.tax)||e.tax<0)return`Invalid tax ${t.tax} in row ${JSON.stringify(t)}`;if(e.currency!=="EUR")return`Expecting only EUR but got ${t.currency} in row ${JSON.stringify(t)}`;const s=e.price*e.shares*(e.type==="Buy"?-1:1);return e.shares!==0&&Math.abs(s-e.amount)>.01?`Invalid amount ${t.amount} - expected ${s} in row ${JSON.stringify(t)}`:""}function U(e){const t=e.split(`
`),s=t[0].split(";");t.shift();const o=[];for(const n of t){if(!n)continue;const r=n.split(";");if(r.length!==s.length)throw new Error(`Invalid row: ${n}`);const i=new Map;for(let d=0;d<s.length;d++){let m=r[d];m.startsWith('"')&&m.endsWith('"')&&(m=m.slice(1,-1)),i.set(s[d],m)}o.push(Object.fromEntries(i))}return o}function W(e){const t=U(e),s=[],o=[];for(const n of t){const r={time:j(n.date,n.time),status:n.status,reference:n.reference,description:n.description,assetType:n.assetType,type:n.type,isin:n.isin,shares:O(n.shares),price:O(n.price),amount:O(n.amount),fee:O(n.fee),tax:O(n.tax),currency:n.currency,sharesSold:0,gainOrLoss:0},i=D(r,n);if(i){o.push(i);continue}s.push(r)}return s.sort((n,r)=>n.time.getTime()-r.time.getTime()),{transactions:s,errors:o}}function O(e){return e?parseFloat(e.replace(/\./,"").replace(/\,/,".")):0}function j(e,t){const s=new Date(e),o=t.split(":");return s.setHours(Number(o[0]),Number(o[1]),Number(o[2])),s}function q(e){const t=e.filter(s=>s.type==="Sell");for(const s of t){const o=e.filter(i=>i.type==="Buy"&&i.isin===s.isin&&i.shares>i.sharesSold);let n=s.shares,r=0;for(const i of o){const d=Math.min(i.shares-i.sharesSold,n);if(i.sharesSold+=d,r+=d*i.price,n-=d,n===0)break}if(n>0)throw new Error(`Not enough shares to sell for ${s.reference}`);s.gainOrLoss=s.amount-r-s.fee-s.tax}return t}function z(e){const t=new Map;for(const s of e){const o=K(s),n=t.get(o)||[];n.push(s),t.set(o,n)}return t}function K(e){return e.isin?e.isin:e.type==="Deposit"||e.type==="Withdrawal"?"Deposit/Withdrawal":e.type}function Q(e){let t=0;for(const s of e)s.type==="Buy"?t+=s.shares:s.type==="Sell"&&(t-=s.shares);return t}const J=document.getElementById("transactionInput");J.addEventListener("change",Y);function Y(){const e=J.files;if(!e)return;const t=e[0];if(!t)return;const s=new FileReader;s.onload=()=>{const o=s.result;V(W(o))},s.onerror=o=>{alert(`Error reading file: ${o}`)},s.readAsText(t)}Y();const M=new Map;function V(e){const t=document.getElementById("transactionOutput");for(const r of e.errors){const i=document.createElement("div");i.innerText=r,i.classList.add("error"),t.appendChild(i)}const s=e.transactions.filter(r=>r.status==="Executed").sort((r,i)=>r.time.getTime()-i.time.getTime());for(const r of s)r.isin&&r.description&&M.set(r.isin,r.description);q(s),t.appendChild(X(s));const o=z(s);let n=null;for(const r of o){const i=r[1],d=_(i);i[0].isin||!n?(t.appendChild(d),n=d):t.insertBefore(d,n)}}function X(e){const t=document.createElement("div"),s=document.createElement("h2");s.innerText="Realized gain / loss per year",t.appendChild(s);const o=e.map(r=>r.time.getUTCFullYear()),n=Array.from(new Set(o)).sort((r,i)=>r-i);for(const r of n){const i=e.filter(d=>d.time.getUTCFullYear()===r&&d.gainOrLoss!==0);i.length!==0&&t.appendChild(Z(r,i))}return t}function Z(e,t){const s=document.createElement("div"),o=document.createElement("h3");o.innerText="Calendar year "+e,s.appendChild(o);const n=document.createElement("table");n.classList.add("yearSecurityTable"),s.appendChild(n);const r=document.createElement("thead");n.appendChild(r);const i=document.createElement("tr");r.appendChild(i);const d=["Security","Gain/Loss"];for(const l of d){const u=document.createElement("th");u.innerText=l,A(l)&&u.classList.add("numeric"),i.appendChild(u)}const m=new Map;for(const l of t){const u=l.isin,h=m.get(u)||0;m.set(u,h+l.gainOrLoss)}for(const[l,u]of m){const h=document.createElement("tr");n.appendChild(h);const L=document.createElement("td"),g=document.createElement("a");g.innerText=M.get(l)||l,g.href="#"+l,L.appendChild(g),h.appendChild(L);const y=document.createElement("td");y.innerText=u.toFixed(2),y.classList.add(u>0?"positive":"negative"),h.appendChild(y)}const v=Array.from(n.rows).slice(1);v.sort((l,u)=>l.cells[0].innerText.localeCompare(u.cells[0].innerText));for(const l of v)n.appendChild(l);const p=document.createElement("tr");p.classList.add("totalRow"),n.appendChild(p);const w=document.createElement("td");w.innerText="Total",p.appendChild(w);const x=document.createElement("td"),N=t.reduce((l,u)=>l+u.gainOrLoss,0);return x.innerText=N.toFixed(2),x.classList.add(N>0?"positive":"negative"),p.appendChild(x),s}function A(e){return["Shares","Price","Amount","Fee","Tax","Gain/Loss"].includes(e)}function _(e){const t=document.createElement("div");if(t.classList.add("transactionGroup"),e.length===0)return t;e.sort((a,c)=>a.time.getTime()-c.time.getTime());const s=e[0],o=s.isin?s.description:s.type,n=document.createElement("h2");if(n.innerText=o,n.id=s.isin,t.appendChild(n),s.isin){const a=document.createElement("h3");a.innerText=`ISIN: ${s.isin}`,t.appendChild(a)}const r=document.createElement("table"),i=document.createElement("div");i.classList.add("tableScroller"),i.appendChild(r),t.appendChild(i);const d=document.createElement("thead"),m=document.createElement("tr");d.appendChild(m),r.appendChild(d);const v=["Time","Type","Shares","Price","Amount","Fee","Tax","Gain/Loss"];for(const a of v){const c=document.createElement("th");c.innerText=a,A(a)&&c.classList.add("numeric"),m.appendChild(c)}for(const a of e){const c=document.createElement("tr");r.appendChild(c);const T=[a.time.toISOString().split("T")[0],a.type,a.shares,a.price,a.amount,a.fee,a.tax,a.gainOrLoss];for(let E=0;E<T.length;E++){const C=T[E],f=document.createElement("td");C===0?f.innerText="":typeof C=="number"?(f.innerText=C.toFixed(2),f.classList.add("numeric"),["Amount","Gain/Loss"].includes(v[E])&&f.classList.add(C>0?"positive":"negative")):f.innerText=String(C),c.appendChild(f)}}const p=document.createElement("tr");p.classList.add("totalRow"),r.appendChild(p);const w=document.createElement("td");w.innerText="Total",p.appendChild(w),p.appendChild(document.createElement("td"));const x=document.createElement("td"),N=Q(e);N&&(x.innerText=N.toFixed(2)),p.appendChild(x),p.appendChild(document.createElement("td"));const l=document.createElement("td"),u=e.reduce((a,c)=>a+c.amount,0);u&&(l.innerText=u.toFixed(2),l.classList.add(u>0?"positive":"negative")),p.appendChild(l);const h=document.createElement("td"),L=e.reduce((a,c)=>a+c.fee,0);L&&(h.innerText=L.toFixed(2),h.classList.add(L>0?"positive":"negative")),p.appendChild(h);const g=document.createElement("td"),y=e.reduce((a,c)=>a+c.tax,0);y&&(g.innerText=y.toFixed(2),g.classList.add(y>0?"positive":"negative")),p.appendChild(g);const b=document.createElement("td"),F=e.reduce((a,c)=>a+c.gainOrLoss,0);F&&(b.innerText=F.toFixed(2),b.classList.add(F>0?"positive":"negative")),p.appendChild(b);const $=new Map;for(const a of e){if(a.gainOrLoss===0)continue;const c=a.time.getUTCFullYear(),T=$.get(c)||0;$.set(c,T+a.gainOrLoss)}if($.size>0){const a=document.createElement("h3");a.innerText=`Gain/Loss for ${o} per year`,t.appendChild(a);const c=document.createElement("table");t.appendChild(c);const T=document.createElement("thead"),E=document.createElement("tr");T.appendChild(E),c.appendChild(T);const C=["Year","Gain/Loss"];for(const f of C){const S=document.createElement("th");S.innerText=f,A(f)&&S.classList.add("numeric"),E.appendChild(S)}for(const[f,S]of $){const I=document.createElement("tr");c.appendChild(I);const G=document.createElement("td");G.innerText=String(f),I.appendChild(G);const R=document.createElement("td");R.innerText=S.toFixed(2),R.classList.add(S>0?"positive":"negative"),I.appendChild(R)}}return t}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:800px;margin:0 auto}.error{color:red}table{border-collapse:collapse}.yearSecurityTable{width:100%}th,td{padding:5px;border:1px solid #ddd;text-align:left;min-width:50px}th,.totalRow{background-color:#f2f2f2;font-weight:700}.numeric{text-align:right}.positive{color:green;text-align:right}.negative{color:red;text-align:right}

</style>
</head>

<body>
  <h1>📖 brokerbuch</h1>
  <p>
    Open-source single-file web app for analysing Scalable Capital stock market broker transaction log.
    <a href="https://github.com/kachurovskiy/brokerbuch/">Learn more on GitHub</a>
  </p>
  <p>
    Transactions CSV: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <p>All amounts shown in Euro. Ignoring cancelled, rejected, pending or expired transactions.</p>
  <div id="transactionOutput"></div>
  
</body>

</html>
