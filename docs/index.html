<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>brokerbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function r(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(t){if(t.ep)return;t.ep=!0;const i=r(t);fetch(t.href,i)}})();const P=["Executed","Cancelled","Expired","Pending","Rejected"],M=["Security","Cash"],Y=["Buy","Sell","Distribution","Interest","Taxes","Fee","Deposit","Withdrawal","Corporate action"];function D(e,n){if(e.time.getFullYear()<2e3||e.time.getFullYear()>2100)return`Invalid year ${e.time.getFullYear()} in row ${JSON.stringify(n)}`;if(!P.includes(e.status))return`Invalid status ${e.status} in row ${JSON.stringify(n)}`;if(!M.includes(e.assetType))return`Invalid asset type ${e.assetType} in row ${JSON.stringify(n)}`;if(!Y.includes(e.type))return`Invalid transaction type ${e.type} in row ${JSON.stringify(n)}`;if(isNaN(e.shares))return`Invalid shares ${n.shares} in row ${JSON.stringify(n)}`;if(isNaN(e.price)||e.price<0)return`Invalid price ${n.price} in row ${JSON.stringify(n)}`;if(isNaN(e.amount))return`Invalid amount ${n.amount} in row ${JSON.stringify(n)}`;if(isNaN(e.fee)||e.fee<0)return`Invalid fee ${n.fee} in row ${JSON.stringify(n)}`;if(isNaN(e.tax)||e.tax<0)return`Invalid tax ${n.tax} in row ${JSON.stringify(n)}`;if(e.currency!=="EUR")return`Expecting only EUR but got ${n.currency} in row ${JSON.stringify(n)}`;const r=e.price*e.shares*(e.type==="Buy"?-1:1);return e.shares!==0&&Math.abs(r-e.amount)>.01?`Invalid amount ${n.amount} - expected ${r} in row ${JSON.stringify(n)}`:""}function W(e){const n=e.split(`
`),r=n[0].split(";");n.shift();const s=[];for(const t of n){if(!t)continue;const i=t.split(";");if(i.length!==r.length)throw new Error(`Invalid row: ${t}`);const a=new Map;for(let l=0;l<r.length;l++){let p=i[l];p.startsWith('"')&&p.endsWith('"')&&(p=p.slice(1,-1)),a.set(r[l],p)}s.push(Object.fromEntries(a))}return s}function H(e){const n=W(e),r=[],s=[];for(const t of n){const i={time:j(t.date,t.time),status:t.status,reference:t.reference,description:t.description,assetType:t.assetType,type:t.type,isin:t.isin,shares:y(t.shares),price:y(t.price),amount:y(t.amount),fee:y(t.fee),tax:y(t.tax),currency:t.currency,sharesSold:0,gainOrLoss:0},a=D(i,t);if(a){s.push(a);continue}r.push(i)}return r.sort((t,i)=>t.time.getTime()-i.time.getTime()),{transactions:r,errors:s}}function y(e){return e?parseFloat(e.replace(/\./,"").replace(/\,/,".")):0}function j(e,n){const r=new Date(e),s=n.split(":");return r.setHours(Number(s[0]),Number(s[1]),Number(s[2])),r}function K(e){const n=e.filter(r=>r.type==="Sell");for(const r of n){const s=e.filter(a=>a.type==="Buy"&&a.isin===r.isin&&a.shares>a.sharesSold);let t=r.shares,i=0;for(const a of s){const l=Math.min(a.shares-a.sharesSold,t);if(a.sharesSold+=l,i+=l*a.price,t-=l,t===0)break}if(t>0)throw new Error(`Not enough shares to sell for ${r.reference}`);r.gainOrLoss=r.amount-i-r.fee-r.tax}return n}function U(e){const n=new Map;for(const r of e){const s=q(r),t=n.get(s)||[];t.push(r),n.set(s,t)}return n}function q(e){return e.isin?e.isin:e.type==="Deposit"||e.type==="Withdrawal"?"Deposit/Withdrawal":e.type}function z(e){let n=0;for(const r of e)r.type==="Buy"?n+=r.shares:r.type==="Sell"&&(n-=r.shares);return n}const G=document.getElementById("transactionInput");G.addEventListener("change",B);function B(){const e=G.files;if(!e)return;const n=e[0];if(!n)return;const r=new FileReader;r.onload=()=>{const s=r.result;Q(H(s))},r.onerror=s=>{alert(`Error reading file: ${s}`)},r.readAsText(n)}B();const T=document.getElementById("transactionOutput");function Q(e){for(const s of e.errors){const t=document.createElement("div");t.innerText=s,t.classList.add("error"),T.appendChild(t)}const n=e.transactions.filter(s=>s.status==="Executed").sort((s,t)=>s.time.getTime()-t.time.getTime());K(n);const r=U(n);for(const s of r){const t=s[1],i=V(t);t[0].isin?T.appendChild(i):T.insertBefore(i,T.firstChild)}}function V(e){const n=document.createElement("div");if(n.classList.add("transactionGroup"),e.length===0)return n;e.sort((o,c)=>o.time.getTime()-c.time.getTime());const r=e[0],s=r.isin?r.description:r.type,t=document.createElement("h2");if(t.innerText=s,n.appendChild(t),r.isin){const o=document.createElement("h3");o.innerText=`ISIN: ${r.isin}`,n.appendChild(o)}const i=document.createElement("table"),a=document.createElement("div");a.classList.add("tableScroller"),a.appendChild(i),n.appendChild(a);const l=document.createElement("thead"),p=document.createElement("tr");l.appendChild(p),i.appendChild(l);const F=["Time","Type","Shares","Price","Amount","Fee","Tax","Gain/Loss"];for(const o of F){const c=document.createElement("th");c.innerText=o,p.appendChild(c)}for(const o of e){const c=document.createElement("tr");i.appendChild(c);const f=[o.time.toISOString().split("T")[0],o.type,o.shares,o.price,o.amount,o.fee,o.tax,o.gainOrLoss];for(let m=0;m<f.length;m++){const h=f[m],u=document.createElement("td");h===0?u.innerText="":typeof h=="number"?(u.innerText=h.toFixed(2),["Amount","Gain/Loss"].includes(F[m])&&u.classList.add(h>0?"positive":"negative")):u.innerText=String(h),c.appendChild(u)}}const d=document.createElement("tr");d.classList.add("totalRow"),i.appendChild(d);const I=document.createElement("td");I.innerText="Total",d.appendChild(I),d.appendChild(document.createElement("td"));const J=document.createElement("td"),R=z(e);R&&(J.innerText=R.toFixed(2)),d.appendChild(J),d.appendChild(document.createElement("td"));const x=document.createElement("td"),S=e.reduce((o,c)=>o+c.amount,0);S&&(x.innerText=S.toFixed(2),x.classList.add(S>0?"positive":"negative")),d.appendChild(x);const C=document.createElement("td"),L=e.reduce((o,c)=>o+c.fee,0);L&&(C.innerText=L.toFixed(2),C.classList.add(L>0?"positive":"negative")),d.appendChild(C);const v=document.createElement("td"),N=e.reduce((o,c)=>o+c.tax,0);N&&(v.innerText=N.toFixed(2),v.classList.add(N>0?"positive":"negative")),d.appendChild(v);const $=document.createElement("td"),O=e.reduce((o,c)=>o+c.gainOrLoss,0);O&&($.innerText=O.toFixed(2),$.classList.add(O>0?"positive":"negative")),d.appendChild($);const E=new Map;for(const o of e){if(o.gainOrLoss===0)continue;const c=o.time.getFullYear(),f=E.get(c)||0;E.set(c,f+o.gainOrLoss)}if(E.size>0){const o=document.createElement("h3");o.innerText=`Gain/Loss for ${s} per year`,n.appendChild(o);const c=document.createElement("table");n.appendChild(c);const f=document.createElement("thead"),m=document.createElement("tr");f.appendChild(m),c.appendChild(f);const h=["Year","Gain/Loss"];for(const u of h){const g=document.createElement("th");g.innerText=u,m.appendChild(g)}for(const[u,g]of E){const b=document.createElement("tr");c.appendChild(b);const A=document.createElement("td");A.innerText=String(u),b.appendChild(A);const w=document.createElement("td");w.innerText=g.toFixed(2),w.classList.add(g>0?"positive":"negative"),b.appendChild(w)}}return n}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:1000px;margin:0 auto}table{border-collapse:collapse}th,td{padding:5px;border:1px solid #ddd;text-align:left}th,.totalRow{background-color:#f2f2f2;font-weight:700}.positive{color:green;text-align:right}.negative{color:red;text-align:right}

</style>
</head>

<body>
  <h1>ðŸ“– brokerbuch</h1>
  <p>
    Open-source single-file web app for analysing Scalable Capital stock market broker transaction log.
    <a href="https://github.com/kachurovskiy/brokerbuch/">Learn more on GitHub</a>
  </p>
  <p>
    Transactions CSV: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <p>All amounts shown in Euro. Ignoring cancelled, rejected, pending or expired transactions.</p>
  <div id="transactionOutput"></div>
  
</body>

</html>
