<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>brokerbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();const M=["Executed","Cancelled","Expired","Pending","Rejected"],P=["Security","Cash"],H=["Buy","Sell","Distribution","Interest","Taxes","Fee","Deposit","Withdrawal","Corporate action"];function K(r,e){if(r.time.getFullYear()<2e3||r.time.getFullYear()>2100)return`Invalid year ${r.time.getFullYear()} in row ${JSON.stringify(e)}`;if(!M.includes(r.status))return`Invalid status ${r.status} in row ${JSON.stringify(e)}`;if(!P.includes(r.assetType))return`Invalid asset type ${r.assetType} in row ${JSON.stringify(e)}`;if(!H.includes(r.type))return`Invalid transaction type ${r.type} in row ${JSON.stringify(e)}`;if(isNaN(r.shares))return`Invalid shares ${e.shares} in row ${JSON.stringify(e)}`;if(isNaN(r.price)||r.price<0)return`Invalid price ${e.price} in row ${JSON.stringify(e)}`;if(isNaN(r.amount))return`Invalid amount ${e.amount} in row ${JSON.stringify(e)}`;if(isNaN(r.fee)||r.fee<0)return`Invalid fee ${e.fee} in row ${JSON.stringify(e)}`;if(isNaN(r.tax)||r.tax<0)return`Invalid tax ${e.tax} in row ${JSON.stringify(e)}`;if(r.currency!=="EUR")return`Expecting only EUR but got ${e.currency} in row ${JSON.stringify(e)}`;const n=r.price*r.shares*(r.type==="Buy"?-1:1);return r.shares!==0&&Math.abs(n-r.amount)>.01?`Invalid amount ${e.amount} - expected ${n} in row ${JSON.stringify(e)}`:""}function W(r){const e=r.split(`
`),n=e[0].split(";");e.shift();const s=[];for(let t of e){if(t=t.trim(),!t)continue;const o=t.split(";");if(o.length!==n.length)throw new Error(`Invalid row: ${t}`);const i=new Map;i.set("raw",t);for(let c=0;c<n.length;c++){let p=o[c];p.startsWith('"')&&p.endsWith('"')&&(p=p.slice(1,-1)),i.set(n[c],p)}s.push(Object.fromEntries(i))}return s}function U(r){const e=W(r),n=[],s=[];for(const t of e){const o={raw:t.raw,time:Z(t.date,t.time),status:t.status,reference:t.reference,description:t.description,assetType:t.assetType,type:t.type,isin:t.isin,shares:$(t.shares),price:$(t.price),amount:$(t.amount),fee:$(t.fee),tax:$(t.tax),currency:t.currency,sharesSold:0,gainOrLoss:0},i=K(o,t);if(i){s.push(i);continue}n.push(o)}return n.sort((t,o)=>t.time.getTime()-o.time.getTime()),{transactions:n,errors:s}}function $(r){return r?parseFloat(r.replace(/\./,"").replace(/\,/,".")):0}function Z(r,e){const n=new Date(r),s=e.split(":");return n.setHours(Number(s[0]),Number(s[1]),Number(s[2])),n}class j{render(e){const n=document.createElement("div");n.classList.add("sectionErrors");for(const s of e.file.errors){const t=document.createElement("div");t.innerText=s,t.classList.add("error"),n.appendChild(t)}return n}}const q=["GB00BLD4ZL17","GB00BNRRF105","GB00BNRRB013","GB00BNRRFW10","GB00BLD4ZN31","DE000A3GVKY4","DE000A3GVKZ1"];function z(r){const e=r.transactions.filter(s=>s.status==="Executed").sort((s,t)=>s.time.getTime()-t.time.getTime());V(e);const n=new Map;for(const s of e)s.isin&&s.description&&n.set(s.isin,s.description);return{cryptoIsins:q,isinToTitle:n,file:r,executedTransactions:e}}function V(r){const e=r.filter(n=>n.type==="Sell");for(const n of e){const s=r.filter(i=>i.type==="Buy"&&i.isin===n.isin&&i.shares>i.sharesSold);let t=n.shares,o=0;for(const i of s){const c=Math.min(i.shares-i.sharesSold,t);if(i.sharesSold+=c,o+=c*i.price+(i.sharesSold===i.shares?i.fee+i.tax:0),t-=c,t===0)break}if(t>0)throw new Error(`Not enough shares to sell for ${n.reference}`);n.gainOrLoss=n.amount-o-n.fee-n.tax}}function k(r){let e=0;for(const n of r)n.type==="Buy"?e+=n.shares:n.type==="Sell"&&(e-=n.shares);return e}function B(r){return["Shares","Price","Amount","Fee","Tax","Gain/Loss"].includes(r)}class A{constructor(e,n,s){this.title=e,this.includeIsins=n,this.excludeIsins=s}render(e){const n=document.createElement("div"),s=document.createElement("h2");s.innerText="Realized gain or loss for "+this.title,n.appendChild(s);const t=e.executedTransactions.filter(c=>this.isinFilter(c)),o=t.filter(c=>this.isinFilter(c)).map(c=>c.time.getUTCFullYear()),i=Array.from(new Set(o)).sort((c,p)=>c-p);for(const c of i){const p=t.filter(g=>g.time.getUTCFullYear()===c&&g.gainOrLoss!==0);p.length!==0&&n.appendChild(this.renderYearSection(e,c,p))}return n}isinFilter(e){return!(this.includeIsins.length&&!this.includeIsins.includes(e.isin)||this.excludeIsins.length&&this.excludeIsins.includes(e.isin))}renderYearSection(e,n,s){const t=document.createElement("div"),o=document.createElement("h3");o.innerText="Calendar year "+n,t.appendChild(o);const i=document.createElement("table");i.classList.add("yearSecurityTable"),t.appendChild(i);const c=document.createElement("thead");i.appendChild(c);const p=document.createElement("tr");c.appendChild(p);const g=["Security","Gain/Loss"];for(const d of g){const u=document.createElement("th");u.innerText=d,B(d)&&u.classList.add("numeric"),p.appendChild(u)}const S=new Map;for(const d of s){const u=d.isin,h=S.get(u)||0;S.set(u,h+d.gainOrLoss)}for(const[d,u]of S){const h=document.createElement("tr");i.appendChild(h);const N=document.createElement("td"),T=document.createElement("a");T.innerText=e.isinToTitle.get(d)||d,T.href="#"+d,N.appendChild(T),h.appendChild(N);const E=document.createElement("td");E.innerText=u.toFixed(2),E.classList.add(u>0?"positive":"negative"),h.appendChild(E)}const m=Array.from(i.rows).slice(1);m.sort((d,u)=>d.cells[0].innerText.localeCompare(u.cells[0].innerText));for(const d of m)i.appendChild(d);const y=document.createElement("tr");y.classList.add("totalRow"),i.appendChild(y);const O=document.createElement("td");O.innerText="Total",y.appendChild(O);const v=document.createElement("td"),w=s.reduce((d,u)=>d+u.gainOrLoss,0);return v.innerText=w.toFixed(2),v.classList.add(w>0?"positive":"negative"),y.appendChild(v),t}}class _{render(e){const n=document.createElement("div"),s=Q(e.executedTransactions),t=[];for(const o of s)t.push(this.renderGroup(o[1]));return t.sort((o,i)=>o.dataset.sortKey.localeCompare(i.dataset.sortKey)),n.replaceChildren(...t),n}renderGroup(e){const n=document.createElement("div");if(n.classList.add("transactionGroup"),e.length===0)return n;e.sort((a,l)=>a.time.getTime()-l.time.getTime());const s=e[0];n.dataset.sortKey=`${s.isin.length>0?1:0}${s.description}`;const t=s.isin?s.description:s.type,o=document.createElement("h2");if(o.innerText=t,o.id=s.isin,n.appendChild(o),s.isin){o.innerText+=" / ";const a=document.createElement("a");a.innerText=s.isin,a.href="https://scalable.capital/broker/security?isin="+s.isin,o.appendChild(a)}const i=document.createElement("table"),c=document.createElement("div");c.classList.add("tableScroller"),c.appendChild(i),n.appendChild(c);const p=document.createElement("thead"),g=document.createElement("tr");p.appendChild(g),i.appendChild(p);const S=["Time","Type","Shares","Price","Amount","Fee","Tax","Gain/Loss"];for(const a of S){const l=document.createElement("th");l.innerText=a,B(a)&&l.classList.add("numeric"),g.appendChild(l)}for(const a of e){const l=document.createElement("tr");l.title=a.raw,i.appendChild(l);const x=[a.time.toISOString().split("T")[0],a.type,a.shares,a.price,a.amount,a.fee,a.tax,a.gainOrLoss];for(let C=0;C<x.length;C++){const L=x[C],f=document.createElement("td");L===0?f.innerText="":typeof L=="number"?(f.innerText=L.toFixed(2),f.classList.add("numeric"),["Amount","Gain/Loss"].includes(S[C])&&f.classList.add(L>0?"positive":"negative")):f.innerText=String(L),l.appendChild(f)}}const m=document.createElement("tr");m.classList.add("totalRow"),i.appendChild(m);const y=document.createElement("td");y.innerText="Total",m.appendChild(y),m.appendChild(document.createElement("td"));const O=document.createElement("td"),v=k(e);v&&(O.innerText=v.toFixed(2)),m.appendChild(O),m.appendChild(document.createElement("td"));const w=document.createElement("td"),d=e.reduce((a,l)=>a+l.amount,0);d&&(w.innerText=d.toFixed(2),w.classList.add(d>0?"positive":"negative")),m.appendChild(w);const u=document.createElement("td"),h=e.reduce((a,l)=>a+l.fee,0);h&&(u.innerText=h.toFixed(2),u.classList.add(h>0?"positive":"negative")),m.appendChild(u);const N=document.createElement("td"),T=e.reduce((a,l)=>a+l.tax,0);T&&(N.innerText=T.toFixed(2),N.classList.add(T>0?"positive":"negative")),m.appendChild(N);const E=document.createElement("td"),I=e.reduce((a,l)=>a+l.gainOrLoss,0);I&&(E.innerText=I.toFixed(2),E.classList.add(I>0?"positive":"negative")),m.appendChild(E);const b=new Map;for(const a of e){if(a.gainOrLoss===0)continue;const l=a.time.getUTCFullYear(),x=b.get(l)||0;b.set(l,x+a.gainOrLoss)}if(b.size>0){const a=document.createElement("br");n.appendChild(a);const l=document.createElement("table");n.appendChild(l);const x=document.createElement("thead"),C=document.createElement("tr");x.appendChild(C),l.appendChild(x);const L=["Year","Gain/Loss"];for(const f of L){const F=document.createElement("th");F.innerText=f,B(f)&&F.classList.add("numeric"),C.appendChild(F)}for(const[f,F]of b){const R=document.createElement("tr");l.appendChild(R);const Y=document.createElement("td");Y.innerText=String(f),R.appendChild(Y);const G=document.createElement("td");G.innerText=F.toFixed(2),G.classList.add(F>0?"positive":"negative"),R.appendChild(G)}}return n}}function Q(r){const e=new Map;for(const n of r){const s=X(n),t=e.get(s)||[];t.push(n),e.set(s,t)}return e}function X(r){return r.isin?r.isin:r.type==="Deposit"||r.type==="Withdrawal"?"Deposit/Withdrawal":r.type}const J=document.getElementById("transactionInput");J.addEventListener("change",D);function D(){const r=J.files;if(!r)return;const e=r[0];if(!e)return;const n=new FileReader;n.onload=()=>{try{ee(U(n.result))}catch(s){alert(`Error parsing file: ${s}`)}},n.onerror=s=>{alert(`Error reading file: ${s}`)},n.readAsText(e)}D();function ee(r){const e=z(r);document.getElementById("transactionOutput").replaceChildren(new j().render(e),new A("stocks",[],e.cryptoIsins).render(e),new A("crypto",e.cryptoIsins,[]).render(e),new _().render(e))}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:800px;margin:0 auto 50px}.error{color:red}table{border-collapse:collapse}.yearSecurityTable{width:100%}th,td{padding:5px;border:1px solid #ddd;text-align:left;min-width:50px}th,.totalRow{background-color:#f2f2f2;font-weight:700}.numeric{text-align:right}.positive{color:green;text-align:right}.negative{color:red;text-align:right}

</style>
</head>

<body>
  <h1>📖 brokerbuch</h1>
  <p>
    Open-source tool for analysing Scalable Capital broker transaction log.
    <a href="https://github.com/kachurovskiy/brokerbuch/">Learn more on GitHub</a>
  </p>
  <p>All amounts shown in Euro. Ignoring cancelled, rejected, pending or expired transactions.</p>
  <p>
    Transactions CSV: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <div id="transactionOutput"></div>
  
</body>

</html>
